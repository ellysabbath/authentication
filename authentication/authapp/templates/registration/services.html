{% extends 'base.html' %}

{% block title %}Services{% endblock %}

{% block content %}
<h5 class="text-center text-success">Available Services</h1>

<section class="section">
    <div class="card">
        <div class="card-body">
            <h6 class="card-title text-center text-primary">full informations of  deacons service</6>
                <div class="table-responsive" style="max-height: 300px; overflow-x: auto; overflow-y: auto;">
                    <table class="table table-bordered table-striped" id="memberTable" data-aos="fade-up" data-aos-duration="500">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Member Name</th>
                                <th>Challenge</th>
                                <th>Bible</th>
                                <th>Morning Service</th>
                                <th>Date</th>
                                <th>Lesson</th>
                                <th>Deacon</th>
                                <th>Song Book</th>
                                <th>Prayer</th>
                                <th>Prayer Time</th>
                                <th>Service</th>
                                <th>Wednesday</th>
                                <th>Friday</th>
                                <th>Saturday</th>
                                <th>Tithes</th>
                                <th>Offerings</th>
                                <th>Camp Offering</th>
                                <th>Other Contributions</th>
                                <th>Assistance</th>
                                <th>Assistance Value</th>
                                <th>Testimony</th>
                                <th>Testimony Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be inserted dynamically here -->
                        </tbody>
                    </table>
                    <!-- script to fetch data and populating to the table -->
                    <script>
                        // Fetch the member data from the API
                        fetch('http://192.168.137.1:8000/auth/view/list_members/')
                            .then(response => response.json())  // Parse the response as JSON
                            .then(data => {
                                if (data && data.length > 0) {
                                    const tableBody = document.querySelector('#memberTable tbody');
                                    
                                    // Clear any existing rows in the table
                                    tableBody.innerHTML = '';
                    
                                    // Loop through the fetched data and insert rows into the table
                                    data.forEach((member, index) => {
                                        // Create a new row
                                        const row = document.createElement('tr');
                    
                                        // Create table data (td) elements for each column
                                        row.innerHTML = `
                                            <td>${index + 1}</td>
                                            <td>${member.name || 'N/A'}</td>
                                            <td>${member.changamoto || 'N/A'}</td> <!-- Correctly referencing changamoto here -->
                                            <td>${member.Biblia || 'N/A'}</td>
                                            <td>${member.kesha || 'N/A'}</td>
                                            <td>${member.date || 'N/A'}</td>
                                            <td>${member.lesson || 'N/A'}</td>
                                            <td>${member.deacon || 'N/A'}</td>
                                            <td>${member.nyimbo || 'N/A'}</td>
                                            <td>${member.maombi || 'N/A'}</td>
                                            <td>${member.maombitime || 'N/A'}</td>
                                            <td>${member.ibada || 'N/A'}</td>
                                            <td>${member.jtano || 'N/A'}</td>
                                            <td>${member.ijumaa || 'N/A'}</td>
                                            <td>${member.sabato || 'N/A'}</td>
                                            <td>${member.zaka || 'N/A'}</td>
                                            <td>${member.sadaka || 'N/A'}</td>
                                            <td>${member.makambi || 'N/A'}</td>
                                            <td>${member.michango || 'N/A'}</td>
                                            <td>${member.misaada || 'N/A'}</td>
                                            <td>${member.thamani || 'N/A'}</td>
                                            <td>${member.injili || 'N/A'}</td>
                                            <td>${member.mudawakuhubiri || 'N/A'}</td>
                                        `;
                    
                                        // Append the row to the table body
                                        tableBody.appendChild(row);
                                    });
                                } else {
                                    console.log('No data available or empty list.');
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching data:', error);
                            });
                    </script>
                    

                </div>

                <!-- fetching data and populating to the table -->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
 <!-- end fetching data from the database and populating to the table -->

        </div>
        <!-- short report -->
        <div class="accordion">
            <!-- Accordion Item -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                        Create short report-daily for deacon
                    </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent=".accordion">
                    <div class="accordion-body">
                        <!-- Content for the "Create short report-daily for deacon" form -->
                        <form id="shortReport">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="name" class="form-label">Deacon Name</label>
                                <input type="text" class="form-control" id="name" name="deaconName" required>
                            </div>
                            <div class="mb-3">
                                <label for="date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="date" name="date" required>
                            </div>
                            <div class="mb-3">
                                <label for="jumla" class="form-label">visited members</label>
                                <input type="number" class="form-control" id="jumla" name="report" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Report</button>
                        </form>
                    </div>
                    <!-- script to send data -->
                   <!-- Include SweetAlert2 library -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Handle form submission with JavaScript
    document.getElementById('shortReport').addEventListener('submit', function(e) {
        e.preventDefault();  // Prevent default form submission

        // Gather form data
        const deaconName = document.getElementById('name').value;
        const date = document.getElementById('date').value;
        const report = document.getElementById('jumla').value;

        // Prepare data to be sent in the request body
        const data = {
            deaconName: deaconName,
            date: date,
            report: report
        };

        // Use Fetch API to send the POST request
        fetch('http://192.168.137.1:8000/auth/deacon/create-report/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value  // CSRF token from the form
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            // Check if the response is successful
            if (data.message === 'Report created successfully!') {
                // Show success SweetAlert
                Swal.fire({
                    title: 'Success!',
                    text: 'Report submitted successfully.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    // Optionally, you can reset the form after submission
                    document.getElementById('shortReport').reset();
                });
            } else {
                // Show error SweetAlert
                Swal.fire({
                    title: 'Error!',
                    text: data.error || 'An error occurred while submitting the report.',
                    icon: 'error',
                    confirmButtonText: 'Try Again'
                });
            }
        })
        .catch(error => {
            // Show error SweetAlert if fetch request fails
            Swal.fire({
                title: 'Error!',
                text: 'An error occurred while submitting the report. Please try again later.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        });
    });
</script>

                    <!-- end of script to send data -->
                </div>
            </div>
        </div>
        
        <!-- Include Bootstrap JS and dependencies if not already added -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
        
        <!-- short report -->
    </div>
</section>

{% endblock %}
